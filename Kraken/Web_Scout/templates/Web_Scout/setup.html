{% extends "base.html" %}
{% block body %}
<div class="alert alert-success" id="success-alert" style="position: fixed;width: 100%;">
        <button type="button" class="close" data-dismiss="alert">x</button>
        <strong>Success!</strong>
        <span id="success-text"></span>
</div>
<div class="alert alert-warning" id="warning-alert" style="position: fixed;width: 100%;">
        <button type="button" class="close" data-dismiss="alert">x</button>
        <strong>Warning!</strong>
        <span id="warning-text"></span>
</div>
<div class="container">

<div class="well">
<form  id="cleardb-form" method = "POST">
	<div class="form-group">
                {% csrf_token %}
                <input type="hidden" class="form-control" name="script" value="cleardb"/>
		<label style="font-size:20px" for="cleardb">Clear the Hosts and Ports tables:</label><br>
        <div style="margin-bottom:5px"><b>Progress:&#160&#160</b><span id="cleardb_progress"></span></div>
		<button id ="cleardb" class="btn btn-primary" type="submit">Clear Database</button>
	</div>
</form>

<form  id="removescreenshots-form" method = "POST">
    <div class="form-group">
                {% csrf_token %}
                <input type="hidden" class="form-control" name="script" value="removescreenshots"/>
        <label style="font-size:20px" for="removescreenshots">Remove all screenshots in screenshot folder:</label><br>
        <div style="margin-bottom:5px"><b>Progress:&#160&#160</b><span id="removescreenshots_progress"></span></div>
        <button id ="removescreenshots" class="btn btn-primary" type="submit">Remove Screenshots</button>
    </div>
</form>

<form id="parse-form" method="POST" role="form">
	<div class="form-group">
                {% csrf_token %}
		<input type="hidden" class="form-control" name="script" value="parse"/>
		<label style="font-size:20px" for="path">Enter path to Nmap XML file (.xml)</label>
		<input class="form-control" name="path" id="path"/>
        <div style="margin-bottom:5px"><b>Progress:&#160&#160</b><span id="parse_progress"></span></div>
		<button id="parse" type="submit" class="btn btn-primary" value="Submit">Parse File</button>
	</div>
</form>
<!-- <input type="file" data-filename-placement="inside"> -->

<form  id="screenshot-form" method = "POST">
        <div class="form-group">
                {% csrf_token %}
                <input type="hidden" class="form-control" name="script" value="screenshot"/>
                <label style="font-size:20px" for="screenshot">Retrieve web interface screenshots:</label><br>
                <div style="margin-bottom:5px"><b>Progress:&#160&#160</b><span id="screenshot_progress"></span></div>
                <button id ="screenshot" class="btn btn-primary" type="submit">Take Screenshots</button>
        </div>
</form>
</div>

<script>
    $(function() {
        //twitter bootstrap script
        $("#success-alert").hide();
        $("#warning-alert").hide();
        $("button#cleardb").click(function(e){
            $("#cleardb_progress").text("")
            e.preventDefault();
            $.ajax({
                type: "POST",
                url: "",
                data: $('form#cleardb-form').serialize(),
                success: function(msg){
                    $("#success-text").text("Request to clear database submitted.")
                    $("#success-alert").alert();
                    PollState('cleardb');
                    $("#success-alert").fadeTo(2000, 500).slideUp(500, function(){
                        $("#success-alert").hide();
                    });  
                },
                error: function(){
                    $("#warning-text").text("A problem was encountered while submitting your request to clear the database.")
                    $("#warning-alert").alert();
                    PollState('cleardb');
                    $("#warning-alert").fadeTo(2000, 500).slideUp(500, function(){
                        $("#warning-alert").hide();
                    }); 
                },
            });
        });
        $("button#removescreenshots").click(function(e){
            $("#removescreenshots_progress").text("")
            e.preventDefault();
            $.ajax({
                type: "POST",
                url: "",
                data: $('form#removescreenshots-form').serialize(),
                success: function(msg){
                    $("#success-text").text("Request to remove screenshots submitted.")
                    $("#success-alert").alert();
                    PollState('removescreenshots');
                    $("#success-alert").fadeTo(2000, 500).slideUp(500, function(){
                        $("#success-alert").hide();
                    });  
                },
                error: function(){
                    $("#warning-text").text("A problem was encountered while submitting your request to remove screenshots.")
                    $("#warning-alert").alert();
                    PollState('removescreenshots');
                    $("#warning-alert").fadeTo(2000, 500).slideUp(500, function(){
                        $("#warning-alert").hide();
                    }); 
                },
            });
        });
        $("button#parse").click(function(e){
            e.preventDefault();
            $("#parse_progress").text("")
            if (document.forms['parse-form'].path.value == ""){
                $("#warning-text").text("You must enter an absolute path.");
                $("#warning-alert").alert();
                $("#warning-alert").fadeTo(2000, 500).slideUp(500, function(){
                    $("#warning-alert").hide();
                }); 
            } else {
                $.ajax({
                    type: "POST",
                    url: "",
                    data: $('form#parse-form').serialize(),
                    success: function(msg){
                        $("#success-text").text("Parsing request submitted.")
                        $("#success-alert").alert();
                        PollState('parse');
                        $("#success-alert").fadeTo(2000, 500).slideUp(500, function(){
                            $("#success-alert").hide();
                        }); 
                    },
                    error: function(){
                        $("#warning-text").text("A problem was encountered while submitting your parse request.")
                        $("#warning-alert").alert();
                        PollState('parse');
                        $("#warning-alert").fadeTo(2000, 500).slideUp(500, function(){
                            $("#warning-alert").hide();
                        }); 
                    },
                });
            };
        });
        $("button#screenshot").click(function(e){
            $("#screenshot_progress").text("")
            e.preventDefault();
            $.ajax({
                type: "POST",
                url: "",
                data: $('form#screenshot-form').serialize(),
                success: function(msg){
                    $("#success-text").text("Screenshot request submitted.")
                    $("#success-alert").alert();
                    PollState('screenshot');
                    $("#success-alert").fadeTo(2000, 500).slideUp(500, function(){
                        $("#success-alert").hide();
                    });
                },
                error: function(){
                    $("#warning-text").text("A problem was encountered while submitting your request to take screenshots.")
                    $("#warning-alert").alert();
                    PollState('screenshot');
                    $("#warning-alert").fadeTo(2000, 500).slideUp(500, function(){
                        $("#warning-alert").hide();
                    }); 
                },
            });
        });
    });
    //jQuery(document).ready(function() {
   
    // pole state of the current task
    var PollState = function(task_id) {
        jQuery.ajax({
            url: "../task_state",
            type: "GET",
            data: "task=" + task_id,
            success: function(task){
                console.log(task);
                console.log(task.process_percent);
                if (task.process_percent) {
                    $('#' + task_id + '_progress').text(task.process_percent + '% Complete');
                } else if (task == 'SUCCESS' || task == 'PENDING'){
                    $('#' + task_id + '_progress').text(task);
                };
     
                // create the infinite loop of Ajax calls to check the state
                // of the current task
                if (task != 'SUCCESS' && task){
                    setTimeout(function(){
                        PollState(task_id);
                    }, 5000);
                };
            }
        });
    }
   
    PollState('cleardb');
    PollState('parse');
    PollState('screenshot');
    PollState('removescreenshots');
    //});
</script>
{% endblock %}

