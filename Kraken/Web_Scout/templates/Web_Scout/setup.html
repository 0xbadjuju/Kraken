{% extends "base.html" %}
{% block head %}
<style>
    .modal.loading .modal-content:before {
        content: 'Oh, Jeppers...';
        text-align: center;
        line-height: 155px;
        font-size: 20px;
        background: rgba(0, 0, 0, .8);
        position: absolute;
        top: 55px;
        bottom: 0;
        left: 0;
        right: 0;
        color: #EEE;
        z-index: 1000;
    }
</style>
{% endblock %}
{% block body %}
<div class="center-block" style="width:95%;">
    <div class="alert alert-success" id="success-alert" style="z-index:5;position:absolute;width:95%;top:55px">
            <button type="button" class="close" data-dismiss="alert">x</button>
            <strong>Success!</strong>
            <span id="success-text"></span>
    </div>
    <div class="alert alert-warning" id="warning-alert" style="z-index:5;position:absolute;width:95%;top:55px">
            <button type="button" class="close" data-dismiss="alert">x</button>
            <strong>Warning!</strong>
            <span id="warning-text"></span>
    </div>
</div>

<div class="modal fade" id="confirm-action" tabindex="-1" role="dialog" aria-labelledby="ConfirmAction" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
                <h4 class="modal-title" id="myModalLabel">Jeppers Check</h4>
            </div>
            <div class="modal-body">
                <p>You are about to <b><i class="title"></i></b>.
                <p>Do you want to proceed?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger btn-ok">Confirm</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
<div class="container">

<div class="well">
<form  id="cleardb-form" method = "POST">
    <div class="form-group">
        {% csrf_token %}
        <input type="hidden" class="form-control" name="script" value="cleardb"/>
        <label style="font-size:20px" for="cleardb">Clear the Hosts and Ports tables:</label><br>
        <div style="margin-bottom:5px"><span id="cleardb_progress"></span></div>
        <button data-toggle="modal" data-target="#confirm-action" data-description="clear the database" data-action="cleardb" id="cleardb" class="btn btn-primary">Clear Database</button>
    </div>
</form>


<form  id="removescreenshots-form" method = "POST">
    <div class="form-group">
        {% csrf_token %}
        <input type="hidden" class="form-control" name="script" value="removescreenshots"/>
        <label style="font-size:20px" for="removescreenshots">Remove all screenshots in screenshot folder:</label><br>
        <div style="margin-bottom:5px"><span id="removescreenshots_progress"></span></div>
        <button data-toggle="modal" data-target="#confirm-action" data-description="remove screenshots" data-action="removescreenshots" id="removescreenshots" class="btn btn-primary">Remove Screenshots</button>
    </div>
</form>

<form id="parse-form" method="POST" role="form" enctype="multipart/form-data">
    <div class="form-group">
        {% csrf_token %}
        <input type="hidden" class="form-control" name="script" value="parse"/>
        
        <label style="font-size:20px" for="path">Enter path to Nmap XML file (.xml)</label>
        <div style="margin-bottom:5px"><span id="parse_progress"></span></div>
        <div class="input-group">
            <label class="input-group-btn">
                <span class="btn btn-primary">
                    Browse&hellip; <input id="uploadfile" name="parsefile" type="file" style="display: none;" multiple>
                </span>
            </label>
            <input type="text" class="form-control" readonly>
        </div><br>
        <button data-toggle="modal" data-description="parse a file into the Kraken database" data-action="parse" id="parse" class="btn btn-primary">Parse File</button>
    </div>
</form>

<form  id="screenshot-form" method = "POST">
    <div class="form-group">
        {% csrf_token %}
        <input type="hidden" class="form-control" name="script" value="screenshot"/>
        <label style="font-size:20px" for="screenshot">Retrieve web interface screenshots:</label><br>
        <div style="margin-bottom:5px"><span id="screenshot_progress"></span></div>
        <button data-toggle="modal" data-target="#confirm-action" data-description="take screenshots" data-action="screenshot" id="screenshot" class="btn btn-primary">Take Screenshots</button>
    </div>
</form>
</div>

<script>
{% if uploaded %}
    $("#success-text").text("File uploaded.")
    $("#success-alert").fadeTo(2000, 500).slideUp(500, function(){
        $("#success-alert").hide();
    }); 
{% else %}
    $("#success-alert").hide();
{% endif %}
{% if failedupload %}
    $("#warning-text").text("Failed to upload file.")
    $("#warning-alert").fadeTo(2000, 500).slideUp(500, function(){
        $("#warning-alert").hide();
    });
{% else %}
    $("#warning-alert").hide();
{% endif %}
    // pole state of the current task
    var PollState = function(task_id) {
        jQuery.ajax({
            url: "../task_state",
            type: "GET",
            data: "task=" + task_id,
            success: function(task){
                console.log(task);
                console.log(task.process_percent);
                if (task.process_percent) {
                    $('#' + task_id + '_progress').text('Progress:  ' +task.process_percent + '% Complete');
                } else if (task == 'SUCCESS' || task == 'PENDING'){
                    $('#' + task_id + '_progress').text('Progress:  ' + task);
                };
     
                // create the infinite loop of Ajax calls to check the state
                // of the current task
                if (task != 'SUCCESS' && task){
                    setTimeout(function(){
                        PollState(task_id);
                    }, 5000);
                };
            }
        });
    };
    PollState('cleardb');
    PollState('parse');
    PollState('screenshot');
    PollState('removescreenshots');

    $("button#cleardb").click(function(e){
        $("#cleardb_progress").text("")
        e.preventDefault();
    });

    $("button#removescreenshots").click(function(e){
        $("#removescreenshots_progress").text("")
        e.preventDefault();
    });

    $("button#parse").click(function(e){
        if ( document.getElementById("uploadfile").files.length == 0 ){
            e.preventDefault();
            e.stopPropagation();
            $("#warning-text").text("You must select a file to upload.");
            $("#warning-alert").alert();
            $("#warning-alert").fadeTo(2000, 500).slideUp(500, function(){
                $("#warning-alert").hide();
            });
            console.log("no files selected");
        };
        //if (document.forms['parse-form'].path.value == ""){
        //    e.stopPropagation();
        //    $("#warning-text").text("You must enter an absolute path.");
        //    $("#warning-alert").alert();
        //    $("#warning-alert").fadeTo(2000, 500).slideUp(500, function(){
        //        $("#warning-alert").hide();
        //    }); 
        //};
    });

    $("button#screenshot").click(function(e){
        $("#screenshot_progress").text("")
        e.preventDefault();
    });
   
    $('#confirm-action').on('click', '.btn-ok', function(e) {
        var $modalDiv = $(e.delegateTarget);
        var action = $(this).data('action');
        console.log("Action: "+action)
        console.log("Description: "+$(this).data('description'));
        var action_description = $(this).data('description')
        $.ajax({
            type: 'POST',
            url: "",
            data: $('form#' + action + '-form').serialize(),
            success: function(msg){
                $("#success-text").text("Request to " + action_description + " submitted.")
                $("#success-alert").alert();
                PollState(action);
                $("#success-alert").fadeTo(2000, 500).slideUp(500, function(){
                    $("#success-alert").hide();
                });  
            },
            error: function(){
                $("#warning-text").text("A problem was encountered while submitting your request to " + action_description + ".")
                $("#warning-alert").alert();
                PollState(action);
                $("#warning-alert").fadeTo(2000, 500).slideUp(500, function(){
                    $("#warning-alert").hide();
                }); 
            },
        })
        $modalDiv.addClass('loading');
        setTimeout(function() {
            $modalDiv.modal('hide').removeClass('loading');
        }, 1000)
    });
    $('#confirm-action').on('show.bs.modal', function(e) {
        var data = $(e.relatedTarget).data();
        $('.title', this).text(data.description);
        $('.btn-ok', this).data('action', data.action);
        $('.btn-ok', this).data('description', data.description)
    });

    $(document).on('change', ':file', function() {
        var input = $(this),
            label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
        input.trigger('fileselect', [label]);
    });
    
    $(document).ready( function() {
        $(':file').on('fileselect', function(event, label) {
    
            var input = $(this).parents('.input-group').find(':text');
    
            if( input.length ) {
                input.val(label);
            } else {
                if( label ) alert(label);
            }
        });
    });
</script>
{% endblock %}
